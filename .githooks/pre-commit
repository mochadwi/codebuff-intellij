#!/bin/bash

# Pre-commit hook: Run ktlint on staged Kotlin files
# Exit with non-zero to abort the commit.

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

STAGED_KT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.kt$|\.kts$' || true)

if [ -z "$STAGED_KT_FILES" ]; then
    echo -e "${GREEN}No Kotlin files staged, skipping ktlint${NC}"
    exit 0
fi

echo -e "${YELLOW}Running ktlint on staged Kotlin files...${NC}"

if command -v docker &> /dev/null && [ -f "docker-compose.yml" ]; then
    docker compose run --rm gradle ktlintCheck --quiet 2>/dev/null || {
        echo -e "${RED}❌ ktlint check failed!${NC}"
        echo -e "${YELLOW}Run 'docker compose run --rm gradle ktlintFormat' to auto-fix${NC}"
        exit 1
    }
elif [ -f "./gradlew" ]; then
    ./gradlew ktlintCheck --quiet 2>/dev/null || {
        echo -e "${RED}❌ ktlint check failed!${NC}"
        echo -e "${YELLOW}Run './gradlew ktlintFormat' to auto-fix${NC}"
        exit 1
    }
else
    echo -e "${YELLOW}⚠️  Neither Docker nor Gradle wrapper found, skipping ktlint${NC}"
    exit 0
fi

echo -e "${GREEN}✅ ktlint check passed!${NC}"
exit 0
